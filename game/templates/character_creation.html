{% extends "base.html" %}

{% block content %}
<style>
    .character-selection {
        text-align: center;
    }
    .character-option {
        display: inline-block;
        margin: 10px;
        vertical-align: top;
    }
    .character-option img {
        width: 100px;
        height: auto;
        border-radius: 50%;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .character-option input[type="radio"] {
        display: none;
    }
    .character-option label {
        cursor: pointer;
        display: block;
    }
    .character-option input[type="radio"]:checked + label {
        outline: 2px solid #f00;
    }
    .confirm-btn {
        background-color: #6200ee;
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
        border-radius: 5px;
        margin-top: 10px;
    }
    .confirm-btn:hover {
        background-color: #3700b3;
    }
    .descriptive-tags {
        color: #fff;
        font-size: 0.7em;
    }
    .selectable {
      background-color: #ffc107; /* A yellow background to highlight the text */
      cursor: pointer; /* Changes the cursor to indicate it's clickable */
      padding: 2px;
      border-radius: 5px;
    }
</style>

{% if character_creation_state == "CHARACTER_AVATAR_SELECTION" %}

    <div class="character-selection">
    <h2>Select Your Character</h2>
    <form method="post">
        {% csrf_token %}
        {% for choice in form.character.field.queryset %}
            <div class="character-option">
                <input type="radio" id="id_character_{{ forloop.counter0 }}" name="character" value="{{ choice.id }}" hidden>
                <label for="id_character_{{ forloop.counter0 }}">
                    <img src="{{ choice.image.url }}" alt="{{ choice }}">
                    <div>{{ choice }}</div> <!-- This will call the __str__ method of the Character model -->
                    <!-- Static descriptive tags displayed here -->
                    <div class="descriptive-tags">{{ choice.description }}</div>
                </label>
            </div>
        {% endfor %}

        <div id="submit"></div>
        <button type="submit" class="confirm-btn">Confirm Selection</button>
    </form>
    </div>

{% elif character_creation_state == "MOON_MEANING_SELECTION" %}
    <!-- Form for Moon Meaning Selection -->
    <div class="moon-meaning-selection">
        <h2>Select Moon Meaning</h2>
        <form method="post" action="{% url 'moon_meaning_submit_url' %}">
            {% csrf_token %}
            <!-- Render your moon meaning selection fields here -->
            <input type="submit" value="Confirm Moon Meaning" class="confirm-btn">
        </form>
    </div>

{% elif character_creation_state == "PUBLIC_PROFILE_CREATION" %}
    <!-- Form for Public Profile Creation -->
    <div class="public-profile-creation">
        <h2>Create Your Public Profile</h2>
            <form id="publicProfileCreationForm" method="post" action="{% url 'character_creation' %}">
            {% csrf_token %}
            <!-- The template for the profile text -->
            <p id="profileText">
              I am "{{ name }}" a "{{ description }}". I am
              <span class="selectable" data-field="quality_1" data-choices="{{ form.quality_1.field.choices|safe }}" onclick="showChoices(this);">[quality #1]</span>
              <span class="selectable" data-field="quality_2" data-choices="{{ form.quality_2.field.choices|safe }}" onclick="showChoices(this);">[quality #2]</span>
              <span class="selectable" data-field="quality_3" data-choices="{{ form.quality_3.field.choices|safe }}" onclick="showChoices(this);">[quality #3]</span>
              I love
              <span class="selectable" data-field="interest_1" data-choices="{{ form.interest_1.field.choices|safe }}" onclick="showChoices(this);">[interest #1]</span>
              <span class="selectable" data-field="interest_2" data-choices="{{ form.interest_2.field.choices|safe }}" onclick="showChoices(this);">[interest #2]</span>
              and
              <span class="selectable" data-field="interest_3" data-choices="{{ form.interest_3.field.choices|safe }}" onclick="showChoices(this);">[interest #3]</span>
              Looking for someone to
              <span class="selectable" data-field="activity_1" data-choices="{{ form.activity_1.field.choices|safe }}" onclick="showChoices(this);">[activity #1]</span>,
              <span class="selectable" data-field="activity_2" data-choices="{{ form.activity_2.field.choices|safe }}" onclick="showChoices(this);">[activity #2]</span> with.

              Also, I love the moon. It's really important to me. Don't message me if you hate the moon!
            </p>

            <!-- The actual form fields, hidden -->
            {{ form.quality_1.as_hidden }}
            {{ form.quality_2.as_hidden }}
            {{ form.quality_3.as_hidden }}
            {{ form.interest_1.as_hidden }}
            {{ form.interest_2.as_hidden }}
            {{ form.interest_3.as_hidden }}
            {{ form.activity_1.as_hidden }}
            {{ form.activity_2.as_hidden }}

            <input type="submit" value="Submit" />
            </form>
    </div>

{% else %}
    <!-- Fallback or error message if the state is unrecognized -->
    <p>Unrecognized character creation state.</p>
{% endif %}
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
      // Function to show the dropdown for choices
      window.showChoices = function(element) {
        // Get the field name and the choices for that field
        const fieldName = element.getAttribute('data-field');
        const choices = JSON.parse(element.getAttribute('data-choices'));

        // Create a new select element
        const select = document.createElement('select');
        select.setAttribute('name', fieldName);
        select.classList.add('dynamic-select');

        // Populate the select element with options
        choices.forEach(function(choice) {
          const option = document.createElement('option');
          option.value = choice[0];
          option.textContent = choice[1];
          select.appendChild(option);
        });

        // Position the select element
        select.style.position = 'absolute';
        select.style.left = element.getBoundingClientRect().left + 'px';
        select.style.top = element.getBoundingClientRect().bottom + 'px';

        // Handle selection of an option
        select.onchange = function() {
          // Update the display text
          element.textContent = this.options[this.selectedIndex].text;
          // Update the value of the corresponding hidden field
          document.querySelector('input[name="' + fieldName + '"]').value = this.value;
          // Remove the select element after selection
          document.body.removeChild(select);
        };

        // Add the select element to the body and focus it
        document.body.appendChild(select);
        select.focus();

        // Remove the select element if we click outside of it
        document.addEventListener('click', function(event) {
          if (event.target !== select) {
            if (select.parentNode) {
              select.parentNode.removeChild(select);
            }
          }
        }, { once: true });
      };
    });

</script>